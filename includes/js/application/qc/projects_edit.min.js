function draw_project(){$.getJSON('qc/project/get_json_data/'+projectid,function(data){$('#projectform td.title:first').html('Edit project');draw_details(data);draw_specs('product',data);draw_specs('qc',data);});}
function draw_details(data){$('#detailstable').html('');var inspectionlevel=document.createElement('span');$(inspectionlevel).attr('id','inspectionlevelspan');if(has_capability('qc:editprojects')){add_radio(inspectionlevel,'inspectionlevela','inspectionlevel',1,'A',data.inspectionlevel,update_details);add_radio(inspectionlevel,'inspectionlevelb','inspectionlevel',2,'B',data.inspectionlevel,update_details);add_radio(inspectionlevel,'inspectionleveltotal','inspectionlevel',3,'Total',data.inspectionlevel,update_details);add_radio(inspectionlevel,'inspectionlevelother','inspectionlevel',4,'Other',data.inspectionlevel,update_details);}else{$(inspectionlevel).load('admin/get_lang_for_constant_value/QC_INSPECTION_LEVEL_/'+data.inspectionlevel);}
var customercode=document.createElement('span');if(has_capability('qc:editprojects')){$(customercode).addClass('edit');}
$(customercode).attr('id','customerproductcode');$(customercode).text(data.customerproductcode);var batchsize=document.createElement('span');if(has_capability('qc:editprojects')){$(batchsize).addClass('edit');}
$(batchsize).attr('id','batchsize');$(batchsize).text(data.batchsize);var samplesize=document.createElement('span');if(has_capability('qc:editprojects')){$(samplesize).addClass('edit');}
$(samplesize).attr('id','samplesize');$(samplesize).text(data.samplesize);var relatedproductsspan=document.createElement('span');var relatedproductslist=document.createElement('ul');$(relatedproductslist).attr('id','relatedproducts');$.each(data.related,function(relatedid,relatedname){$(relatedproductslist).append(make_related_item(relatedid,relatedname));});$(relatedproductsspan).append(relatedproductslist);if(has_capability('qc:editprojects')){var relatedproductinput=make_autocomplete_input('relatedproduct','related_product_id','','Add a related product: ','/qc/project/related_project_suggest/'+projectid,add_related);var relatedlabel=document.createElement('label');$(relatedlabel).attr('for','relatedproduct');$(relatedlabel).html(relatedproductinput.label);$(relatedproductsspan).append(relatedlabel);$(relatedproductsspan).append(relatedproductinput.input);}
var shippingmarks=document.createElement('span');$(shippingmarks).attr('id','shippingmarks');if(has_capability('qc:editprojects')){$(shippingmarks).editable('qc/project/update_standard_variable/'+projectid,{id:'field',type:'textarea',cols:60,rows:7,callback:function(){redraw_saverevision_button();},onblur:'submit',loadurl:'qc/project/get_shipping_marks/'+projectid,loadtype:'POST'});}
if(!data.shippingmarks){data.shippingmarks=constants.QC_DEFAULT_SHIPPING_MARKS_LINE_1+"\n"
+constants.QC_DEFAULT_SHIPPING_MARKS_LINE_2+"\n"
+constants.QC_DEFAULT_SHIPPING_MARKS_LINE_3+"\n"
+constants.QC_DEFAULT_SHIPPING_MARKS_LINE_4+"\n"
+constants.QC_DEFAULT_SHIPPING_MARKS_LINE_5+"\n"
+constants.QC_DEFAULT_SHIPPING_MARKS_LINE_6+"\n"
+constants.QC_DEFAULT_SHIPPING_MARKS_LINE_7;}
data.shippingmarks=nl2br(data.shippingmarks);$(shippingmarks).html(data.shippingmarks);var approvedproductspan=document.createElement('span');var approvedqcspan=document.createElement('span');var approvedproductinput=document.createElement('input');var approvedqcinput=document.createElement('input');$(approvedproductinput).attr('id','approved_product_customer');$(approvedproductinput).attr('name','approved_product_customer');$(approvedproductinput).attr('type','text');$(approvedqcinput).attr('id','approved_qc_customer');$(approvedqcinput).attr('name','approved_qc_customer');$(approvedqcinput).attr('type','text');var approvedproductdate,approvedqcdate;$.datepicker.setDefaults({dateFormat:'dd/mm/yy',changeMonth:true,changeYear:true,defaultDate:null});approvedproductdate=new Date();if(data.approvedproductcustomer>0){approvedproductdate.setTime(data.approvedproductcustomer*1000);}
approvedqcdate=new Date();if(data.approvedqccustomer>0){approvedqcdate.setTime(data.approvedqccustomer*1000);}
$(approvedproductinput).datepicker({defaultDate:approvedproductdate});$(approvedqcinput).datepicker({defaultDate:approvedqcdate});$(approvedproductinput).bind('change',update_details);$(approvedqcinput).bind('change',update_details);$(approvedproductspan).append(approvedproductinput);$(approvedqcspan).append(approvedqcinput);if(data.approvedproductcustomer>0){$(approvedproductinput).val(approvedproductdate.format('dd/mm/yyyy'));$(approvedproductspan).append(make_action_icon('delete','Record as non-approved',function(){var answer=confirm('Record this project\'s product specifications as non-approved?');if(answer){$(approvedproductinput).val('0');$(approvedproductinput).trigger('change');}
return false;},'inlineicon'));}
if(data.approvedqccustomer>0){$(approvedqcinput).val(approvedqcdate.format('dd/mm/yyyy'));$(approvedqcspan).append(make_action_icon('delete','Record as non-approved',function(){var answer=confirm('Record this project\'s QA specifications as non-approved?');if(answer){$(approvedqcinput).val('0');$(approvedqcinput).trigger('change');}
return false;},'inlineicon'));}
var permitteddefectspan=document.createElement('span');$(permitteddefectspan).attr('id','permitteddefect');if(has_capability('qc:editprojects')){add_percentage_dropdown(permitteddefectspan,'defectcriticallimit',data.defectcriticallimit,'Cri',update_details);add_percentage_dropdown(permitteddefectspan,'defectmajorlimit',data.defectmajorlimit,'Maj',update_details);add_percentage_dropdown(permitteddefectspan,'defectminorlimit',data.defectminorlimit,'Min',update_details);}else{$(permitteddefectspan).text('Cri['+data.defectcriticallimit+'%] Maj['+data.defectmajorlimit+'%] Min['+data.defectminorlimit+'%]');}
var projectstatus=document.createElement('span');var projectstatustext=document.createElement('span');var projectstatusicon=document.createElement('img');$(projectstatusicon).addClass('icon');var icon='traffic_slow';var title='Pending';if(data.result){if(data.result==constants.QC_RESULT_PASS){icon='traffic_go';title='Passed';}else if(data.result==constants.QC_RESULT_REJECT){icon='traffic_stop';title='Rejected';}}
$(projectstatusicon).attr('src',constants.PATH_IMAGES_ADMIN+'/icons/'+icon+'_16.gif');$(projectstatusicon).attr('title',title);$(projectstatusicon).attr('alt',title);$(projectstatustext).text(title);$(projectstatus).append(projectstatusicon);$(projectstatus).append(projectstatustext);var approvedadminspan=document.createElement('span');if(has_capability('qc:approveprojects')){var approvedprojectadmin=make_choice('approvedprojectadmin','approved_project_admin',1,'checkbox',(data.approvedprojectadmin>0));var approvedprojectadminlabel=make_label('approvedprojectadmin','Project');$(approvedprojectadmin).bind('change',update_details);$(approvedprojectadminlabel).addClass('approved');$(approvedadminspan).append(approvedprojectadminlabel);$(approvedadminspan).append(approvedprojectadmin);}else{var approvedprojectspan=document.createElement('p');if(data.approvedprojectadminname){$(approvedprojectspan).html('Project: Approved by '+data.approvedprojectadminname);}else{$(approvedprojectspan).html('Project: Un-approved');}
$(approvedadminspan).append(approvedprojectspan);}
if(has_capability('qc:approveproductspecs')){var approvedproductadmin=make_choice('approvedproductadmin','approved_product_admin',1,'checkbox',(data.approvedproductadmin>0));var approvedproductadminlabel=make_label('approvedproductadmin','Product specs');$(approvedproductadmin).bind('change',update_details);$(approvedproductadminlabel).addClass('approved');$(approvedadminspan).append(approvedproductadminlabel);$(approvedadminspan).append(approvedproductadmin);}else{var approvedproductadminspan=document.createElement('p');if(data.approvedproductadminname){$(approvedproductadminspan).html('Product Specifications: Approved by '+data.approvedproductadminname);}else{$(approvedproductadminspan).html('Product Specifications: Un-approved');}
$(approvedadminspan).append(approvedproductadminspan);}
if(has_capability('qc:approveproductspecs')){var approvedqcadmin=make_choice('approvedqcadmin','approved_qc_admin',1,'checkbox',(data.approvedqcadmin>0));var approvedqcadminlabel=make_label('approvedqcadmin','QC specs');$(approvedqcadmin).bind('change',update_details);$(approvedqcadminlabel).addClass('approved');$(approvedadminspan).append(approvedqcadminlabel);$(approvedadminspan).append(approvedqcadmin);}else{var approvedqcadminspan=document.createElement('p');if(data.approvedqcadminname){$(approvedqcadminspan).html('QA Specifications: Approved by '+data.approvedqcadminname);}else{$(approvedqcadminspan).html('QA Specifications: Un-approved');}
$(approvedadminspan).append(approvedqcadminspan);}
var revisionelements=get_revision_elements(data.projectid);add_data_row('detailstable','CS Job No.',data.jobno,'Product Name',data.productname);add_data_row('detailstable','CS Product Code',data.productcode,'Customer Prod Code',customercode);add_data_row('detailstable',revisionelements.revisionnotext,data.revisionstring,'Last revision date',data.lastrevisiondate);add_data_row('detailstable','Last udpated by',data.lastupdatedby,'Batch Size',batchsize);add_data_row('detailstable','Inspection level',inspectionlevel,'Sample Size',samplesize);add_data_row('detailstable','Related Products',relatedproductsspan,'Shipping marks',shippingmarks);add_data_row('detailstable','Product specifications customer approved date',approvedproductspan,'QA specifications customer approved date',approvedqcspan);add_data_row('detailstable','Permitted Defect',permitteddefectspan,'Result',projectstatus);add_data_row('detailstable','Admin approved',approvedadminspan,revisionelements.revisionbutton);$('#detailstable').removeAttr('colSpan');$(document.createElement('br')).insertAfter(revisionelements.revisionnotext);if(data.containschanges==1){redraw_saverevision_button();}
$('.edit').attr('title','Click to edit');$('.edit').editable('qc/project/update_standard_variable/'+projectid,{id:'field',width:'160px',callback:function(){redraw_saverevision_button();},onblur:'submit'});}
function make_related_item(relatedid,relatedname){relateditem=document.createElement('li');$(relateditem).attr('id','related_'+relatedid);relatedlink=document.createElement('a');$(relatedlink).attr('href','/qc/project/edit/'+relatedid);$(relatedlink).text(relatedname);$(relateditem).append(relatedlink);if(has_capability('qc:editprojects')){$(relateditem).append(make_action_icon('delete','Remove this related product',function(){var answer=confirm('Do you really want to this related product? Only the association with this project will be removed, not the product itself.');if(answer){delete_related(relatedid,relatedname);}
return false;},'inlineicon'));}
return relateditem;}
function add_related(event,ui){$('#detailsmessage').loading();var relatedid=ui.item.value;var relatedname=ui.item.label;$.getJSON('qc/project/add_related/'+projectid+'/'+relatedid,function(data){print_edit_message('details',$.toJSON(data));if(data.type=='success'){$('#relatedproducts').append(make_related_item(relatedid,relatedname));redraw_saverevision_button();}});}
function delete_related(relatedid,relatedname){$('#detailsmessage').loading();$.getJSON('qc/project/delete_related/'+projectid+'/'+relatedid,function(data){print_edit_message('details',$.toJSON(data));$('#related_'+relatedid).remove();var relatedoption=document.createElement('option');$(relatedoption).attr('value',relatedid);$(relatedoption).text(relatedname);$('#relatedproductsselect').append(relatedoption);redraw_saverevision_button();});}
function update_details(data){$('#detailsmessage').loading();var value=$(this).val();if($(this).attr('type')=='checkbox'){value=$(this).attr('checked');value=(value)?'1':'0';}
if(value.length<1){value='0';}
var name=$(this).attr('name');$.post('qc/project/update_standard_variable/'+projectid,{field:name,value:value},function(data){print_edit_message('details',$.toJSON(data));if(name!='approved_project_admin'&&name!='approved_product_admin'&&name!='approved_qc_admin'){redraw_saverevision_button();}},'json');}
function processJson(data){$('.error').text('');$.each(data.errors,function(field,error){print_error(field,error);});print_edit_message('details',$.toJSON(data));redraw();}
function draw_part_selector(){var duplicateinput=make_autocomplete_input('duplicate','duplicate','','QC Project to duplicate','/qc/project/project_suggest',select_project_to_duplicate);var partsinput=make_autocomplete_input('part','partid','','Product','/qc/project/part_suggest',create_project);var row1=document.createElement('tr');var row2=document.createElement('tr');var cell1=document.createElement('td');$(cell1).attr('id','duplicate_cell');var duplicatehidden=document.createElement('input');$(duplicatehidden).attr('type','hidden');$(duplicatehidden).attr('name','duplicate_project_id');var header1=document.createElement('th');var header2=document.createElement('th');var cell2=document.createElement('td');$(header1).html(duplicateinput.label);$(cell1).html(duplicateinput.input);$(cell1).append(duplicatehidden);$(row1).append(header1);$(row1).append(cell1);$(header2).html(partsinput.label);$(cell2).html(partsinput.input);$(row2).append(header2);$(row2).append(cell2);$('#detailstable').append(row1);$('#detailstable').append(row2);}
function select_project_to_duplicate(event,ui){$('input[name="duplicate_project_id"]').val(ui.item.value);$('#duplicate').remove();var duplicate_text=document.createElement('span');$(duplicate_text).html(ui.item.label);$('#duplicate_cell').prepend(duplicate_text);}
function create_project(event,ui){$('#part').loading();$.getJSON('qc/project/save_project/'+ui.item.value+'/'+$('input[name="duplicate_project_id"]').val(),function(data){print_edit_message('project',$.toJSON(data));projectid=data.projectid;draw_details(data);draw_specs('product',data);$('a [title=\'pdf\']').each(function(data){var link=$(this).parent();$(link).attr('href',$(link).attr('href')+projectid);});});}
$(document).ready(function(){$.loading.classname='loading';$.getJSON('qc/project/get_spec_photo_counts/'+projectid,function(data){specphotocounts=data;if(projectid==0){$('#projectform td.title:first').html('New project');draw_part_selector();}else{draw_project();}});});